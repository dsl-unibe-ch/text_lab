Bootstrap: docker
From: nvidia/cuda:12.4.1-cudnn-runtime-ubuntu22.04

%environment
    # External model locations (bind-mount at runtime)
    export WHISPER_CACHE=/opt/whisper
    export WHISPERX_CACHE=/opt/whisperx
    
    export TORCH_HOME=/opt/torch
    
    export HF_HOME=/opt/huggingface
    export HUGGINGFACE_HUB_CACHE=/opt/huggingface/hub
    export TRANSFORMERS_CACHE=/opt/huggingface/transformers

    export EASYOCR_CACHE=/opt/easyocr
    export PADDLEOCR_CACHE=/opt/paddleocr
    export PADDLEX_HOME=/opt/paddlex

    export OLLAMA_MODELS=/opt/ollama/models
    
    export SSL_CERT_FILE=/etc/ssl/certs/ca-certificates.crt
    export SSL_CERT_DIR=/etc/ssl/certs
    export REQUESTS_CA_BUNDLE=/etc/ssl/certs/ca-certificates.crt

    # Ollama runtime libs path
    export LD_LIBRARY_PATH=/usr/local/lib/ollama:$LD_LIBRARY_PATH

%post
    set -e
    export DEBIAN_FRONTEND=noninteractive

    # Shared model/cache dirs
    mkdir -p \
        /opt/whisper \
        /opt/ollama/models \
        /opt/whisperx \
        /opt/torch \
        /opt/huggingface \
        /opt/huggingface/hub \
        /opt/huggingface/transformers \
        /opt/easyocr \
        /opt/paddleocr \
        /opt/paddlex
    chmod -R a+rX /opt/whisper /opt/ollama /opt/whisperx /opt/torch /opt/huggingface /opt/easyocr /opt/paddleocr /opt/paddlex

    apt-get update
    apt-get install -y software-properties-common \
        ca-certificates \
        curl \
        git \
        build-essential \
        pkg-config \
        ffmpeg \
        libsndfile1 \
        zstd \
        python3-apt


    ##### Apptainer #####
    add-apt-repository -y ppa:apptainer/ppa
    apt-get update
    apt-get install -y apptainer


    ##### OlmOCR dependencies #####
    apt-get update
    apt-get install -y poppler-utils ttf-mscorefonts-installer msttcorefonts fonts-crosextra-caladea fonts-crosextra-carlito gsfonts lcdf-typetools


    ##### Python 3.11 as default #####
    add-apt-repository -y ppa:deadsnakes/ppa
    apt-get update
    apt-get install -y python3.11 python3.11-dev python3.11-venv python3.11-distutils
    curl -sS https://bootstrap.pypa.io/get-pip.py -o /tmp/get-pip.py
    python3.11 /tmp/get-pip.py
    rm -f /tmp/get-pip.py

    update-alternatives --install /usr/bin/python3 python3 /usr/bin/python3.11 20
    update-alternatives --set python3 /usr/bin/python3.11
    update-alternatives --install /usr/bin/python python /usr/bin/python3.11 20
    update-alternatives --set python /usr/bin/python3.11


    ### General dependencies ###
    apt-get remove -y python3-blinker

    python -m pip install --no-cache-dir --upgrade pip setuptools wheel

    pip install torch==2.7.1 torchvision==0.22.1 torchaudio==2.7.1 --index-url https://download.pytorch.org/whl/cu118

    cat > /tmp/constraints.txt <<'EOF'
torch==2.7.1+cu118
torchvision==0.22.1+cu118
torchaudio==2.7.1+cu118
pyannote-audio>=3.3.2,<4.0.0
huggingface_hub<1.0.0
transformers<5
ctranslate2<4.5.0
EOF

    python -m pip install --no-cache-dir --upgrade \
        streamlit \
        streamlit-cookies-manager \
        requests \
        openai-whisper \
        sentence-transformers \
        scikit-learn \
        umap-learn \
        matplotlib \
        numpy \
        pandas \
        seaborn \
        plotly \
        ipython \
        jupyter \
        jupyterlab \
        ipykernel \
        polars \
        pyarrow \
        openpyxl \
        datasets \
        soundfile \
        opencv-python-headless \
        scikit-image \
        mcp[cli] \
        openai \
        tabulate \
        tqdm \
        filelock \
        evaluate \
        librosa \
        --constraint /tmp/constraints.txt


    ##### WhisperX dependencies #####
    apt-get install libcudnn8 libcudnn8-dev -y
    python -m pip install --no-cache-dir --upgrade whisperx==3.4.1 silero_vad --constraint /tmp/constraints.txt


    ##### Ollama dependencies #####
    curl -fsSL https://ollama.com/install.sh | sh
    python -m pip install --no-cache-dir --upgrade ollama


    ##### OCR dependencies #####
    python -m pip install --no-cache-dir --upgrade paddlepaddle-gpu==3.3.0 -i https://www.paddlepaddle.org.cn/packages/stable/cu118/
    python -m pip install --no-cache-dir --upgrade paddleocr paddlex easyocr
    # python -m pip install --no-cache-dir --upgrade olmocr[gpu] --extra-index-url https://download.pytorch.org/whl/cu118 --constraint /tmp/constraints.txt

    python -m pip install --no-cache-dir --upgrade \
        "vllm==0.10.0" \
        "olmocr[gpu]" \
        --extra-index-url https://download.pytorch.org/whl/cu118 \
        --constraint /tmp/constraints.txt



    ##### Final cleaning #####
    apt-get clean
    rm -rf /var/lib/apt/lists/*

%runscript
    exec "$@"
